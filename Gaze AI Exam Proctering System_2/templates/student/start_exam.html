{% extends 'student/studentbase.html' %} {% block content %} {%load static%}

<head>
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css"
        rel="stylesheet" id="bootstrap-css">
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
    <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>

    <!-- jQuery and jQuery UI CDN links -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet"
        href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <style>
        #floating-window {
            position: fixed;
            top: 10px;
            right: 10px;
            border: 1px solid #ccc;
            background-color: #fff;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            cursor: move;
            z-index: 1000;
            width: 280px;
        }

        #processed-output {
            width: 100%;
            height: 100%;
        }

        video {
            width: 1px;
            height: 1px;
            position: absolute;
            visibility: hidden;
        }

        #status-display {
            margin-top: 10px;
            padding: 10px;
            font-size: 12px;
        }

        .question-container {
            background-color: #f8f9fa;
            transition: all 0.3s ease;
        }
        .question-container:hover {
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .question-text {
            font-size: 1.1rem;
            color: #2c3e50;
        }
        .form-check-label {
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        .form-check-label:hover {
            background-color: #e9ecef;
        }
        .badge {
            font-size: 1rem;
            padding: 8px 16px;
        }
    </style>
</head>

<div class="jumbotron my-4">
    <!-- Hidden video elements -->
    <video id="camera" width="1" height="1" autoplay style="position: absolute; visibility: hidden;"></video>
    <canvas id="output" width="640" height="480" style="display: none;"></canvas>

    <div id="floating-window">
        <canvas id="processed-output" width="250" height="220"></canvas>
        <div id="status-display"></div>
        <div class="handle" style="position: absolute; bottom: 0; right: 0; width: 20px; height: 20px; cursor: se-resize;">â‹®</div>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-md-10 offset-md-1">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3 class="text-center mb-0">{{course.course_name}}</h3>
                        <p class="text-center mb-0">Total Questions: {{total_questions}} | Total Marks: {{total_marks}}</p>
                    </div>
                    <div class="card-body">
                        <form class="form" autocomplete="off" onsubmit="return saveAns()" 
                            action="/student/calculate-marks" method="POST">
                            {% csrf_token %}
                            {% for q in questions %}
                            <div class="question-container mb-4 p-3 border rounded">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h4 class="text-primary">Question {{ forloop.counter }}</h4>
                                    <span class="badge badge-info">{{q.marks}} Marks</span>
                                </div>
                                <p class="question-text mt-2">{{q.question}}</p>
                                <div class="options-container mt-3">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" 
                                            name="{{ forloop.counter }}" 
                                            id="option1_{{forloop.counter}}" 
                                            value="Option1">
                                        <label class="form-check-label" 
                                            for="option1_{{forloop.counter}}">
                                            {{q.option1}}
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" 
                                            name="{{ forloop.counter }}" 
                                            id="option2_{{forloop.counter}}" 
                                            value="Option2">
                                        <label class="form-check-label" 
                                            for="option2_{{forloop.counter}}">
                                            {{q.option2}}
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" 
                                            name="{{ forloop.counter }}" 
                                            id="option3_{{forloop.counter}}" 
                                            value="Option3">
                                        <label class="form-check-label" 
                                            for="option3_{{forloop.counter}}">
                                            {{q.option3}}
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" 
                                            name="{{ forloop.counter }}" 
                                            id="option4_{{forloop.counter}}" 
                                            value="Option4">
                                        <label class="form-check-label" 
                                            for="option4_{{forloop.counter}}">
                                            {{q.option4}}
                                        </label>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            <div class="text-center mt-4">
                                <button type="submit" class="btn btn-success btn-lg px-5">
                                    Submit Answers
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let violationCount = 0;
    let warningCount = 0;

    function handleEmotionAnalysis(data) {
        const violation_type = data.violation_type;
        const status = data.result.toLowerCase();
        const gaze_direction = data.gaze_direction;

        // Increment the count for violations
        if (status === 'true') {
            violationCount++;
            
            // Show warning after multiple violations
            if (violationCount >= 3) {
                alert('Warning: Multiple suspicious activities detected. Please focus on your exam. Further violations may result in termination.');
                violationCount = 0;
                warningCount++;
                
                // Terminate exam after multiple warnings
                if (warningCount >= 3) {
                    alert('Exam terminated due to multiple violations.');
                    window.location.href = '/';
                    return;
                }
            }
        }

        // Update the UI
        document.getElementById('status-display').innerHTML = `
            <div class="alert ${status === 'true' ? 'alert-danger' : 'alert-success'}">
                <strong>Status:</strong> ${violation_type}<br>
                <strong>Gaze Direction:</strong> ${gaze_direction}
            </div>
        `;
        
        const processedContext = processedCanvas.getContext('2d');
        const img = new Image();
        img.onload = function () {
            processedContext.drawImage(img, 0, 0, 250, 220);
        };
        img.src = 'data:image/jpeg;base64,' + data.processed_frame;
    }

    const video = document.getElementById('camera');
    const canvas = document.getElementById('output');
    const processedCanvas = document.getElementById('processed-output');

    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            video.srcObject = stream;
            video.play().catch(err => console.error("Error playing video:", err));
        })
        .catch(err => console.error("Error accessing camera:", err));

    setInterval(() => {
        const context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, 640, 480);

        // Capture the frame as a Blob
        canvas.toBlob(blob => {
            const formData = new FormData();
            formData.append('frame', blob, 'frame.jpg');

            fetch('/student/process-emotion/', {
                method: 'POST',
                body: formData,
            })
                .then(response => response.json())
                .then(data => {
                    handleEmotionAnalysis(data);
                })
                .catch(error => console.error('Error:', error));
        }, 500);
    }, 500);

    // Enhanced floating window controls
    const floatingWindow = document.getElementById('floating-window');
    let isDragging = false;
    let isResizing = false;
    let offsetX, offsetY;

    // Dragging functionality
    floatingWindow.addEventListener('mousedown', (event) => {
        if (event.target.classList.contains('handle')) {
            isResizing = true;
        } else {
            isDragging = true;
            offsetX = event.clientX - floatingWindow.getBoundingClientRect().left;
            offsetY = event.clientY - floatingWindow.getBoundingClientRect().top;
            floatingWindow.style.cursor = 'grabbing';
        }
    });

    document.addEventListener('mousemove', (event) => {
        if (isDragging) {
            const x = event.clientX - offsetX;
            const y = event.clientY - offsetY;
            
            // Keep window within viewport bounds
            const maxX = window.innerWidth - floatingWindow.offsetWidth;
            const maxY = window.innerHeight - floatingWindow.offsetHeight;
            
            floatingWindow.style.left = Math.min(Math.max(0, x), maxX) + 'px';
            floatingWindow.style.top = Math.min(Math.max(0, y), maxY) + 'px';
        }
        
        if (isResizing) {
            const width = event.clientX - floatingWindow.getBoundingClientRect().left;
            const height = event.clientY - floatingWindow.getBoundingClientRect().top;
            
            // Set minimum size
            const minWidth = 200;
            const minHeight = 150;
            
            floatingWindow.style.width = Math.max(minWidth, width) + 'px';
            floatingWindow.style.height = Math.max(minHeight, height) + 'px';
            
            // Resize the canvas proportionally
            processedCanvas.style.width = '100%';
            processedCanvas.style.height = 'auto';
        }
    });

    document.addEventListener('mouseup', () => {
        isDragging = false;
        isResizing = false;
        floatingWindow.style.cursor = 'move';
    });

    // Prevent text selection while dragging
    floatingWindow.addEventListener('dragstart', (e) => {
        e.preventDefault();
    });

    function saveAns() {
        var ele = document.getElementsByTagName('input');
        for (i = 0; i < ele.length; i++) {
            if (ele[i].type = "radio") {
                if (ele[i].checked) {
                    setCookie(ele[i].name, ele[i].value, 3)
                }
            }
        }
    }

    function setCookie(cname, cvalue, exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
        var expires = "expires=" + d.toUTCString();
        document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
    }

    // Add this after your existing script
    function startTimer(duration) {
        let timer = duration;
        const timerDisplay = document.getElementById('time-left');
        
        const countdown = setInterval(() => {
            const minutes = parseInt(timer / 60, 10);
            const seconds = parseInt(timer % 60, 10);
            
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (--timer < 0) {
                clearInterval(countdown);
                alert('Time is up! Your answers will be submitted automatically.');
                document.querySelector('form').submit();
            }
            
            // Warning when 5 minutes remaining
            if (timer === 300) {
                alert('5 minutes remaining!');
            }
        }, 1000);
    }
    
    // Start timer when page loads (e.g., 60 minutes)
    document.addEventListener('DOMContentLoaded', () => {
        startTimer(60 * 60); // 60 minutes
    });

    function scrollToQuestion(num) {
        const questionCards = document.querySelectorAll('.question-card');
        questionCards[num-1].scrollIntoView({ behavior: 'smooth' });
    }
    
    // Update navigation buttons when answers are selected
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const questionNum = this.name;
            document.querySelectorAll('.question-nav-btn')[questionNum-1].classList.add('btn-success');
        });
    });
</script>

<br><br><br><br><br><br> {% endblock content %}